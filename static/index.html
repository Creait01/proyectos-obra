<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ProyectOS - Gestión de Proyectos de Obra</title>
    <link rel="stylesheet" href="/static/styles.css?v=3.6.7">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Auth Screen -->
    <div id="auth-screen" class="auth-screen">
        <div class="auth-background">
            <div class="gradient-sphere sphere-1"></div>
            <div class="gradient-sphere sphere-2"></div>
            <div class="gradient-sphere sphere-3"></div>
        </div>
        <div class="auth-container glass-card">
            <div class="auth-header">
                <div class="logo">
                    <i class="fas fa-hard-hat"></i>
                    <span>ProyectOS</span>
                </div>
                <p class="tagline">Gestión colaborativa de proyectos de obra</p>
            </div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">Iniciar Sesión</button>
                <button class="auth-tab" data-tab="register">Registrarse</button>
            </div>
            
            <form id="login-form" class="auth-form">
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="login-email" required placeholder="tu@email.com">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Contraseña</label>
                    <input type="password" id="login-password" required placeholder="••••••••">
                </div>
                <button type="submit" class="btn btn-primary btn-full">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
            </form>
            
            <form id="register-form" class="auth-form hidden">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Nombre</label>
                    <input type="text" id="register-name" required placeholder="Tu nombre">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="register-email" required placeholder="tu@email.com">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Contraseña</label>
                    <input type="password" id="register-password" required placeholder="••••••••">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-palette"></i> Color de Avatar</label>
                    <div class="color-picker">
                        <input type="color" id="register-color" value="#6366f1">
                        <span class="color-preview"></span>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-full">
                    <i class="fas fa-user-plus"></i> Crear Cuenta
                </button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="main-app hidden">
        <!-- Sidebar -->
        <aside class="sidebar glass-dark">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-hard-hat"></i>
                    <span>ProyectOS</span>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-view="dashboard" data-label="Dashboard">
                    <i class="fas fa-chart-pie"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-view="kanban" data-label="Kanban">
                    <i class="fas fa-columns"></i>
                    <span>Kanban</span>
                </a>
                <a href="#" class="nav-item" data-view="gantt" data-label="Gantt">
                    <i class="fas fa-stream"></i>
                    <span>Gantt</span>
                </a>
                <a href="#" class="nav-item" data-view="my-tasks" data-label="Mis Tareas">
                    <i class="fas fa-tasks"></i>
                    <span>Mis Tareas</span>
                </a>
                <a href="#" class="nav-item" data-view="projects" data-label="Proyectos">
                    <i class="fas fa-building"></i>
                    <span>Proyectos</span>
                </a>
                <a href="#" class="nav-item" data-view="team" data-label="Equipo">
                    <i class="fas fa-users"></i>
                    <span>Equipo</span>
                </a>
                <a href="#" class="nav-item admin-only hidden" data-view="admin" data-label="Administración">
                    <i class="fas fa-user-shield"></i>
                    <span>Administración</span>
                    <span class="badge pending-count hidden">0</span>
                </a>
            </nav>

            <button class="btn-icon" id="sidebar-toggle" title="Expandir/Contraer">
                <i class="fas fa-angles-left"></i>
            </button>
            
            <div class="sidebar-projects">
                <div class="sidebar-section-header">
                    <span>Proyectos</span>
                    <button class="btn-icon" id="add-project-btn" title="Nuevo proyecto">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div id="project-list" class="project-list"></div>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-info" id="user-info">
                    <div class="avatar"></div>
                    <div class="user-details">
                        <span class="user-name"></span>
                        <span class="user-email"></span>
                    </div>
                </div>
                    <button class="btn-icon" id="logout-btn" title="Cerrar sesión">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="topbar glass">
                <div class="topbar-left">
                    <button class="btn-icon mobile-menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 id="page-title">Dashboard</h1>
                </div>
                <div class="topbar-right">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Buscar tareas..." id="search-input">
                    </div>
                    <div class="report-buttons">
                        <button class="btn btn-outline btn-report" id="download-general-report" title="Reporte General PDF">
                            <i class="fas fa-file-pdf"></i>
                            <span>Reporte General</span>
                        </button>
                        <button class="btn btn-outline btn-report" id="download-project-report" title="Reporte del Proyecto" style="display: none;">
                            <i class="fas fa-file-pdf"></i>
                            <span>Reporte Proyecto</span>
                        </button>
                    </div>
                    <!-- Indicador de conexión oculto -->
                    <div class="connection-status hidden" id="connection-status">
                        <i class="fas fa-wifi"></i>
                        <span>Conectado</span>
                    </div>
                </div>
            </header>

            <!-- Views Container -->
            <div class="views-container">
                <!-- Dashboard View -->
                <section id="dashboard-view" class="view active">
                    <div class="dashboard-grid">
                        <div class="stats-row projects-row">
                            <div class="stat-card glass-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                                    <i class="fas fa-project-diagram"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-value" id="stat-projects-total">0</span>
                                    <span class="stat-label">Proyectos</span>
                                </div>
                            </div>
                            <div class="stat-card glass-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #34d399);">
                                    <i class="fas fa-circle-check"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-value" id="stat-projects-active">0</span>
                                    <span class="stat-label">Activos</span>
                                </div>
                            </div>
                            <div class="stat-card glass-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #64748b, #94a3b8);">
                                    <i class="fas fa-circle-pause"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-value" id="stat-projects-inactive">0</span>
                                    <span class="stat-label">Inactivos</span>
                                </div>
                            </div>
                        </div>

                        <div class="stats-row tasks-row">
                            <div class="stat-card glass-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #06b6d4, #0ea5e9);">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-value" id="stat-tasks-total">0</span>
                                    <span class="stat-label">Total Tareas</span>
                                </div>
                            </div>
                            <div class="stat-card glass-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #64748b, #94a3b8);">
                                    <i class="fas fa-list"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-value" id="stat-tasks-todo">0</span>
                                    <span class="stat-label">Por Hacer</span>
                                </div>
                            </div>
                            <div class="stat-card glass-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                                    <i class="fas fa-spinner"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-value" id="stat-tasks-progress">0</span>
                                    <span class="stat-label">En Progreso</span>
                                </div>
                            </div>
                            <div class="stat-card glass-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #f97316);">
                                    <i class="fas fa-eye"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-value" id="stat-tasks-review">0</span>
                                    <span class="stat-label">En Revisión</span>
                                </div>
                            </div>
                            <div class="stat-card glass-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #34d399);">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-value" id="stat-tasks-done">0</span>
                                    <span class="stat-label">Completadas</span>
                                </div>
                            </div>
                            <div class="stat-card glass-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa);">
                                    <i class="fas fa-rotate"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-value" id="stat-tasks-restart">0</span>
                                    <span class="stat-label">Reinicio</span>
                                </div>
                            </div>
                            <div class="stat-card glass-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444, #f87171);">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-value" id="stat-tasks-overdue">0</span>
                                    <span class="stat-label">Vencidas</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-row">
                            <div class="chart-card glass-card">
                                <h3><i class="fas fa-chart-doughnut"></i> Progreso General</h3>
                                <div class="progress-ring-container">
                                    <svg class="progress-ring" width="200" height="200">
                                        <circle class="progress-ring-bg" cx="100" cy="100" r="80"/>
                                        <circle class="progress-ring-fill" cx="100" cy="100" r="80" id="progress-ring"/>
                                    </svg>
                                    <div class="progress-ring-text">
                                        <span id="completion-rate">0%</span>
                                        <small>Completado</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tarjeta de Efectividad -->
                            <div class="chart-card glass-card effectiveness-card">
                                <h3><i class="fas fa-tachometer-alt"></i> Efectividad del Proyecto</h3>
                                <select id="effectiveness-project-select" class="select-styled" style="margin-bottom: 15px;">
                                    <option value="">Seleccionar proyecto</option>
                                </select>
                                <div id="effectiveness-content" class="effectiveness-content">
                                    <div class="effectiveness-gauge">
                                        <div class="gauge-value" id="effectiveness-value">--%</div>
                                        <div class="gauge-label">Efectividad</div>
                                    </div>
                                    <div class="effectiveness-comparison">
                                        <div class="effectiveness-item">
                                            <span class="label">Programado</span>
                                            <div class="progress-mini">
                                                <div class="progress-mini-fill scheduled" id="scheduled-bar" style="width: 0%"></div>
                                            </div>
                                            <span class="value" id="scheduled-value">0%</span>
                                        </div>
                                        <div class="effectiveness-item">
                                            <span class="label">Real</span>
                                            <div class="progress-mini">
                                                <div class="progress-mini-fill actual" id="actual-bar" style="width: 0%"></div>
                                            </div>
                                            <span class="value" id="actual-value">0%</span>
                                        </div>
                                    </div>
                                    <div class="effectiveness-status" id="effectiveness-status">
                                        <i class="fas fa-clock"></i>
                                        <span>Selecciona un proyecto</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="chart-card glass-card">
                                <h3><i class="fas fa-flag"></i> Por Prioridad</h3>
                                <div class="priority-bars">
                                    <div class="priority-bar">
                                        <div class="priority-label">
                                            <span class="priority-dot high"></span>
                                            <span>Alta</span>
                                        </div>
                                        <div class="bar-container">
                                            <div class="bar high" id="bar-high"></div>
                                        </div>
                                        <span class="priority-count" id="count-high">0</span>
                                    </div>
                                    <div class="priority-bar">
                                        <div class="priority-label">
                                            <span class="priority-dot medium"></span>
                                            <span>Media</span>
                                        </div>
                                        <div class="bar-container">
                                            <div class="bar medium" id="bar-medium"></div>
                                        </div>
                                        <span class="priority-count" id="count-medium">0</span>
                                    </div>
                                    <div class="priority-bar">
                                        <div class="priority-label">
                                            <span class="priority-dot low"></span>
                                            <span>Baja</span>
                                        </div>
                                        <div class="bar-container">
                                            <div class="bar low" id="bar-low"></div>
                                        </div>
                                        <span class="priority-count" id="count-low">0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="activity-card glass-card">
                                <h3><i class="fas fa-history"></i> Actividad Reciente</h3>
                                <div id="activity-list" class="activity-list"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Kanban View -->
                <section id="kanban-view" class="view">
                    <div class="kanban-header">
                        <select id="kanban-project-select" class="select-styled">
                            <option value="">Seleccionar proyecto</option>
                        </select>
                        <div class="kanban-actions">
                            <button class="btn btn-secondary" id="apply-task-template-btn" title="Cargar tareas desde plantilla">
                                <i class="fas fa-magic"></i> Plantilla
                            </button>
                            <button class="btn btn-primary" id="add-task-btn">
                                <i class="fas fa-plus"></i> Nueva Tarea
                            </button>
                        </div>
                    </div>
                    <div class="kanban-board" id="kanban-board">
                        <div class="kanban-column" data-status="todo">
                            <div class="column-header">
                                <div class="column-title">
                                    <span class="column-dot todo"></span>
                                    <h3>Por Hacer</h3>
                                    <span class="task-count" id="count-todo">0</span>
                                </div>
                            </div>
                            <div class="column-content" id="column-todo"></div>
                        </div>
                        <div class="kanban-column" data-status="in_progress">
                            <div class="column-header">
                                <div class="column-title">
                                    <span class="column-dot in_progress"></span>
                                    <h3>En Progreso</h3>
                                    <span class="task-count" id="count-in_progress">0</span>
                                </div>
                            </div>
                            <div class="column-content" id="column-in_progress"></div>
                        </div>
                        <div class="kanban-column" data-status="review">
                            <div class="column-header">
                                <div class="column-title">
                                    <span class="column-dot review"></span>
                                    <h3>En Revisión</h3>
                                    <span class="task-count" id="count-review">0</span>
                                </div>
                            </div>
                            <div class="column-content" id="column-review"></div>
                        </div>
                        <div class="kanban-column" data-status="restart">
                            <div class="column-header">
                                <div class="column-title">
                                    <span class="column-dot restart"></span>
                                    <h3>Reinicio</h3>
                                    <span class="task-count" id="count-restart">0</span>
                                </div>
                            </div>
                            <div class="column-content" id="column-restart"></div>
                        </div>
                        <div class="kanban-column" data-status="done">
                            <div class="column-header">
                                <div class="column-title">
                                    <span class="column-dot done"></span>
                                    <h3>Completado</h3>
                                    <span class="task-count" id="count-done">0</span>
                                </div>
                            </div>
                            <div class="column-content" id="column-done"></div>
                        </div>
                    </div>
                </section>

                <!-- Gantt View -->
                <section id="gantt-view" class="view">
                    <div class="gantt-header">
                        <select id="gantt-project-select" class="select-styled">
                            <option value="">Seleccionar proyecto</option>
                        </select>
                        <div class="gantt-controls">
                            <!-- Navegación temporal -->
                            <div class="gantt-navigation">
                                <button class="gantt-nav-btn" id="gantt-prev-month" title="Mes anterior">
                                    ◀
                                </button>
                                <span class="gantt-date-display" id="gantt-date-display">Enero 2026</span>
                                <button class="gantt-nav-btn" id="gantt-next-month" title="Mes siguiente">
                                    ▶
                                </button>
                            </div>
                            <button class="btn btn-primary" id="gantt-today" title="Ir a hoy">
                                <i class="fas fa-calendar-day"></i> Hoy
                            </button>
                            <button class="btn btn-success admin-only" id="gantt-add-task" title="Nueva actividad">
                                <i class="fas fa-plus"></i> Nueva Actividad
                            </button>
                        </div>
                    </div>
                    
                    <!-- Métricas de Efectividad del Gantt -->
                    <div class="gantt-effectiveness" id="gantt-effectiveness">
                        <div class="gantt-effectiveness-item scheduled" title="Porcentaje que debería estar completado a día de hoy según las fechas de las tareas">
                            <div>
                                <div class="metric-value" id="gantt-scheduled">--%</div>
                                <div class="metric-label">Programado <i class="fas fa-info-circle info-icon"></i></div>
                            </div>
                        </div>
                        <div class="gantt-effectiveness-item actual" title="Porcentaje real de avance reportado en las tareas">
                            <div>
                                <div class="metric-value" id="gantt-actual">--%</div>
                                <div class="metric-label">Real <i class="fas fa-info-circle info-icon"></i></div>
                            </div>
                        </div>
                        <div class="gantt-effectiveness-item effectiveness" title="Efectividad = (Real / Programado) × 100. Mayor a 100% = Adelantado">
                            <div>
                                <div class="metric-value" id="gantt-effectiveness-value">--%</div>
                                <div class="metric-label">Efectividad <i class="fas fa-info-circle info-icon"></i></div>
                            </div>
                        </div>
                        <div class="gantt-effectiveness-item" id="gantt-status-container">
                            <span id="gantt-status-text">Selecciona un proyecto</span>
                        </div>
                    </div>
                    
                    <!-- Efectividad por Etapas -->
                    <div class="gantt-stages-effectiveness" id="gantt-stages-effectiveness">
                        <!-- Se llenará dinámicamente con las etapas y su efectividad -->
                    </div>
                    
                    <!-- Leyenda de cálculos -->
                    <div class="gantt-legend">
                        <div class="legend-item">
                            <i class="fas fa-calendar-check"></i>
                            <span><strong>Programado:</strong> % que debería estar completado según fechas</span>
                        </div>
                        <div class="legend-item">
                            <i class="fas fa-tasks"></i>
                            <span><strong>Real:</strong> % de avance actual de las tareas</span>
                        </div>
                        <div class="legend-item">
                            <i class="fas fa-chart-line"></i>
                            <span><strong>Efectividad:</strong> Real ÷ Programado × 100 (≥100% = adelantado)</span>
                        </div>
                    </div>
                    
                    <div class="gantt-container glass-card">
                        <div class="gantt-chart" id="gantt-chart">
                            <div class="gantt-timeline" id="gantt-timeline"></div>
                            <div class="gantt-tasks" id="gantt-tasks"></div>
                        </div>
                    </div>
                </section>

                <!-- My Tasks View -->
                <section id="my-tasks-view" class="view">
                    <div class="my-tasks-header">
                        <div class="filter-tabs">
                            <button class="filter-tab active" data-filter="all">Todas</button>
                            <button class="filter-tab" data-filter="todo">Por Hacer</button>
                            <button class="filter-tab" data-filter="in_progress">En Progreso</button>
                            <button class="filter-tab" data-filter="review">En Revision</button>
                            <button class="filter-tab" data-filter="done">Completadas</button>
                        </div>
                        <div class="priority-filter">
                            <label for="my-tasks-priority-filter">Filtrar por prioridad</label>
                            <select id="my-tasks-priority-filter">
                                <option value="all">Todas</option>
                                <option value="high">Alta</option>
                                <option value="medium">Media</option>
                                <option value="low">Baja</option>
                            </select>
                        </div>
                        <div class="status-filter">
                            <label for="my-tasks-status-filter">Filtrar por estado</label>
                            <select id="my-tasks-status-filter">
                                <option value="all">Todos</option>
                                <option value="todo">Por Hacer</option>
                                <option value="in_progress">En Progreso</option>
                                <option value="review">En Revision</option>
                                <option value="done">Completadas</option>
                            </select>
                        </div>
                    </div>
                    <div class="tasks-list" id="my-tasks-list"></div>
                </section>

                <!-- Team View -->
                <section id="team-view" class="view">
                    <div class="team-grid" id="team-grid"></div>
                </section>

                <!-- Projects View -->
                <section id="projects-view" class="view">
                    <div class="projects-grid" id="projects-grid"></div>
                </section>

                <!-- Admin View -->
                <section id="admin-view" class="view">
                    <div class="admin-container">
                        <div class="admin-tabs">
                            <button class="admin-tab active" data-tab="pending">
                                <i class="fas fa-clock"></i> Pendientes
                                <span class="badge" id="pending-badge">0</span>
                            </button>
                            <button class="admin-tab" data-tab="all-users">
                                <i class="fas fa-users"></i> Usuarios
                            </button>
                            <button class="admin-tab" data-tab="templates">
                                <i class="fas fa-copy"></i> Plantillas
                            </button>
                            <button class="admin-tab" data-tab="teams">
                                <i class="fas fa-user-friends"></i> Equipos
                            </button>
                        </div>

                        <div class="admin-panel" id="admin-pending">
                            <div class="admin-header">
                                <h3><i class="fas fa-user-clock"></i> Usuarios Pendientes de Aprobación</h3>
                                <p class="admin-subtitle">Aprueba o rechaza las solicitudes de registro</p>
                            </div>
                            <div class="pending-users-list" id="pending-users-list">
                                <div class="empty-state">
                                    <i class="fas fa-check-circle"></i>
                                    <p>No hay usuarios pendientes</p>
                                </div>
                            </div>
                        </div>

                        <div class="admin-panel hidden" id="admin-all-users">
                            <div class="admin-header">
                                <h3><i class="fas fa-users-cog"></i> Gestión de Usuarios</h3>
                                <p class="admin-subtitle">Administra los usuarios del sistema</p>
                            </div>
                            <div class="all-users-list" id="all-users-list"></div>
                        </div>
                        
                        <!-- Plantillas Panel -->
                        <div class="admin-panel hidden" id="admin-templates">
                            <div class="admin-header">
                                <h3><i class="fas fa-copy"></i> Plantillas</h3>
                                <p class="admin-subtitle">Crea plantillas de etapas y tareas para precargar en proyectos</p>
                            </div>
                            
                            <div class="templates-section">
                                <!-- Plantillas de Etapas -->
                                <div class="template-category">
                                    <div class="template-category-header">
                                        <h4><i class="fas fa-layer-group"></i> Plantillas de Etapas</h4>
                                        <button class="btn btn-primary btn-sm" onclick="openStageTemplateModal()">
                                            <i class="fas fa-plus"></i> Nueva Plantilla
                                        </button>
                                    </div>
                                    <div class="templates-list" id="stage-templates-list">
                                        <div class="empty-state">
                                            <i class="fas fa-folder-open"></i>
                                            <p>No hay plantillas de etapas</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Plantillas de Tareas -->
                                <div class="template-category">
                                    <div class="template-category-header">
                                        <h4><i class="fas fa-tasks"></i> Plantillas de Tareas</h4>
                                        <button class="btn btn-primary btn-sm" onclick="openTaskTemplateModal()">
                                            <i class="fas fa-plus"></i> Nueva Plantilla
                                        </button>
                                    </div>
                                    <div class="templates-list" id="task-templates-list">
                                        <div class="empty-state">
                                            <i class="fas fa-folder-open"></i>
                                            <p>No hay plantillas de tareas</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Equipos Panel -->
                        <div class="admin-panel hidden" id="admin-teams">
                            <div class="admin-header">
                                <h3><i class="fas fa-user-friends"></i> Equipos de Administradores</h3>
                                <p class="admin-subtitle">Asigna miembros a cada administrador</p>
                            </div>
                            <div class="teams-grid" id="teams-grid">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Project Modal -->
    <div class="modal-overlay" id="project-modal">
        <div class="modal glass-card">
            <div class="modal-header">
                <h2 id="project-modal-title">Nuevo Proyecto</h2>
                <button class="btn-icon modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="project-form">
                <input type="hidden" id="project-id">
                <div class="form-group">
                    <label>Nombre del Proyecto</label>
                    <input type="text" id="project-name" required placeholder="Ej: Construcción Edificio Norte">
                </div>
                <div class="form-group">
                    <label>Descripción</label>
                    <textarea id="project-description" rows="3" placeholder="Descripción del proyecto..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha de Inicio</label>
                        <input type="date" id="project-start">
                    </div>
                    <div class="form-group">
                        <label>Fecha de Fin</label>
                        <input type="date" id="project-end">
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-ruler-combined"></i> Metros Cuadrados</label>
                    <input type="number" id="project-square-meters" step="0.01" min="0" placeholder="Ej: 1500.50">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-image"></i> Imagen del Proyecto</label>
                    <div class="image-upload-container">
                        <div class="image-preview" id="project-image-preview">
                            <i class="fas fa-building"></i>
                            <span>Sin imagen</span>
                        </div>
                        <div class="image-upload-actions">
                            <label class="btn btn-secondary btn-sm" for="project-image-input">
                                <i class="fas fa-upload"></i> Subir imagen
                            </label>
                            <input type="file" id="project-image-input" accept="image/*" style="display: none;">
                            <button type="button" class="btn btn-danger btn-sm" id="project-image-remove" style="display: none;">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                    <small class="form-hint">Formatos: JPG, PNG, GIF, WEBP</small>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-user-tie"></i> Coordinador</label>
                        <select id="project-coordinator" class="select-styled">
                            <option value="">Sin asignar</option>
                        </select>
                        <small class="form-hint">Persona que coordina el proyecto</small>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-user-cog"></i> Líder</label>
                        <select id="project-leader" class="select-styled">
                            <option value="">Sin asignar</option>
                        </select>
                        <small class="form-hint">Líder técnico del proyecto</small>
                    </div>
                </div>
                <div class="form-group">
                    <label>Color del Proyecto</label>
                    <div class="color-options" id="project-colors">
                        <button type="button" class="color-option" data-color="#6366f1" style="background: #6366f1;"></button>
                        <button type="button" class="color-option" data-color="#8b5cf6" style="background: #8b5cf6;"></button>
                        <button type="button" class="color-option" data-color="#ec4899" style="background: #ec4899;"></button>
                        <button type="button" class="color-option" data-color="#ef4444" style="background: #ef4444;"></button>
                        <button type="button" class="color-option" data-color="#f59e0b" style="background: #f59e0b;"></button>
                        <button type="button" class="color-option" data-color="#10b981" style="background: #10b981;"></button>
                        <button type="button" class="color-option" data-color="#06b6d4" style="background: #06b6d4;"></button>
                        <button type="button" class="color-option" data-color="#3b82f6" style="background: #3b82f6;"></button>
                    </div>
                    <input type="hidden" id="project-color" value="#6366f1">
                </div>
                <div class="form-group">
                    <label>Estado del Proyecto</label>
                    <label class="switch">
                        <input type="checkbox" id="project-active" checked>
                        <span class="slider"></span>
                    </label>
                    <small class="form-hint">Activo = visible en listas y selector</small>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-users"></i> Miembros del Proyecto</label>
                    <div class="members-selector" id="project-members-selector">
                        <!-- Se llenará con JavaScript -->
                    </div>
                    <small class="form-hint">Selecciona los usuarios que trabajarán en este proyecto</small>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-layer-group"></i> Etapas del Proyecto</label>
                    
                    <!-- Selector de Plantilla de Etapas -->
                    <div class="template-selector-container">
                        <select id="stage-template-select" class="select-styled">
                            <option value="">-- Cargar desde plantilla (opcional) --</option>
                        </select>
                        <button type="button" class="btn btn-secondary btn-sm" id="apply-stage-template-btn" title="Aplicar plantilla seleccionada">
                            <i class="fas fa-magic"></i> Aplicar
                        </button>
                    </div>
                    
                    <div class="stages-container" id="project-stages-container">
                        <!-- Se llenará con JavaScript -->
                    </div>
                    <div class="stages-actions">
                        <button type="button" class="btn btn-secondary btn-sm" id="add-stage-btn">
                            <i class="fas fa-plus"></i> Agregar Etapa
                        </button>
                    </div>
                    <small class="form-hint">Arrastra las etapas para reordenarlas. Deben sumar 100%</small>
                    <div class="stages-total">
                        <span>Total: <strong id="stages-total-percentage">0%</strong></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal-overlay" id="task-modal">
        <div class="modal glass-card modal-large">
            <div class="modal-header">
                <h2 id="task-modal-title">Nueva Tarea</h2>
                <button class="btn-icon modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label>Título de la Tarea</label>
                    <input type="text" id="task-title" required placeholder="Ej: Revisar planos estructurales">
                </div>
                <div class="form-group">
                    <label>Descripción</label>
                    <textarea id="task-description" rows="4" placeholder="Detalles de la tarea..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="task-status">
                            <option value="todo">Por Hacer</option>
                            <option value="in_progress">En Progreso</option>
                            <option value="review">En Revisión</option>
                            <option value="restart">Reinicio</option>
                            <option value="done">Completado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Prioridad</label>
                        <select id="task-priority">
                            <option value="low">Baja</option>
                            <option value="medium">Media</option>
                            <option value="high">Alta</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha de Inicio</label>
                        <input type="date" id="task-start">
                    </div>
                    <div class="form-group">
                        <label>Fecha de Vencimiento</label>
                        <input type="date" id="task-due">
                    </div>
                </div>
                <div class="form-group">
                    <label>Asignar a</label>
                    <input type="hidden" id="task-assignee" value="">
                    <div class="assignee-chips-container" id="assignee-chips-container">
                        <!-- Los chips se generan dinámicamente -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Etapa del Proyecto</label>
                    <select id="task-stage">
                        <option value="">Sin etapa</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Progreso: <span id="progress-value">0</span>%</label>
                    <input type="range" id="task-progress" min="0" max="100" value="0">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="view-history-btn" style="margin-right: auto;">
                        <i class="fas fa-history"></i> Historial
                    </button>
                    <button type="button" class="btn btn-danger admin-only" id="delete-task-btn">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                    <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                    <button type="submit" class="btn btn-primary admin-only">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task History Modal -->
    <div class="modal-overlay" id="history-modal">
        <div class="modal glass-card modal-large">
            <div class="modal-header">
                <h2><i class="fas fa-history"></i> Historial de Cambios</h2>
                <button class="btn-icon modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="history-task-title" id="history-task-title"></div>
            <div class="history-container" id="history-container">
                <div class="history-loading">
                    <i class="fas fa-spinner fa-spin"></i> Cargando historial...
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal (para usuarios normales) -->
    <div class="modal-overlay" id="progress-modal">
        <div class="modal glass-card">
            <div class="modal-header">
                <h2><i class="fas fa-chart-line"></i> Registrar Avance</h2>
                <button class="btn-icon modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="progress-form">
                <input type="hidden" id="progress-task-id">
                <div class="progress-task-info">
                    <h3 id="progress-task-title"></h3>
                    <p id="progress-current">Progreso actual: <span>0%</span></p>
                </div>
                <div class="form-group">
                    <label>Nuevo Progreso: <span id="new-progress-value">0</span>%</label>
                    <input type="range" id="new-progress" min="0" max="100" value="0">
                </div>
                <div class="form-group">
                    <label>Comentario (opcional)</label>
                    <textarea id="progress-comment" rows="3" placeholder="Describe el avance realizado..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="openProgressHistory()">
                        <i class="fas fa-history"></i> Ver Historial
                    </button>
                    <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Avance
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Progress History Modal -->
    <div class="modal-overlay" id="history-modal">
        <div class="modal glass-card modal-large">
            <div class="modal-header">
                <h2><i class="fas fa-history"></i> Historial de Avances</h2>
                <button class="btn-icon modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="history-content" id="history-content">
                <div class="empty-state">
                    <i class="fas fa-clipboard-list"></i>
                    <p>No hay registros de avance</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal-overlay" id="edit-user-modal">
        <div class="modal glass-card">
            <div class="modal-header">
                <h2><i class="fas fa-user-edit"></i> Editar Usuario</h2>
                <button class="btn-icon modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="edit-user-form">
                <input type="hidden" id="edit-user-id">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Nombre</label>
                    <input type="text" id="edit-user-name" required placeholder="Nombre del usuario">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="edit-user-email" required placeholder="email@ejemplo.com">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Nueva Contraseña (dejar vacío para mantener)</label>
                    <input type="password" id="edit-user-password" placeholder="••••••••">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-user-shield"></i> Rol</label>
                    <select id="edit-user-role">
                        <option value="user">Usuario</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Stage Template Modal -->
    <div class="modal-overlay" id="stage-template-modal">
        <div class="modal glass-card modal-lg">
            <div class="modal-header">
                <h2><i class="fas fa-layer-group"></i> Plantilla de Etapas</h2>
                <button class="btn-icon modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="stage-template-form">
                <div class="form-group">
                    <label>Nombre de la Plantilla</label>
                    <input type="text" id="stage-template-name" required placeholder="Ej: Obra Civil Estándar">
                </div>
                <div class="form-group">
                    <label>Descripción</label>
                    <textarea id="stage-template-description" rows="2" placeholder="Descripción de la plantilla..."></textarea>
                </div>
                <div class="template-items-section">
                    <div class="template-items-header">
                        <h4>Etapas de la Plantilla</h4>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addStageTemplateItem()">
                            <i class="fas fa-plus"></i> Agregar Etapa
                        </button>
                    </div>
                    <div class="template-items-list" id="stage-template-items">
                        <!-- Items dinámicos -->
                    </div>
                    <div class="template-total">
                        Total: <span id="stage-template-total">0</span>%
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Plantilla
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Template Modal -->
    <div class="modal-overlay" id="task-template-modal">
        <div class="modal glass-card modal-lg">
            <div class="modal-header">
                <h2><i class="fas fa-tasks"></i> Plantilla de Tareas</h2>
                <button class="btn-icon modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="task-template-form">
                <div class="form-group">
                    <label>Nombre de la Plantilla</label>
                    <input type="text" id="task-template-name" required placeholder="Ej: Tareas de Fundaciones">
                </div>
                <div class="form-group">
                    <label>Descripción</label>
                    <textarea id="task-template-description" rows="2" placeholder="Descripción de la plantilla..."></textarea>
                </div>
                <div class="template-items-section">
                    <div class="template-items-header">
                        <h4>Tareas de la Plantilla</h4>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addTaskTemplateItem()">
                            <i class="fas fa-plus"></i> Agregar Tarea
                        </button>
                    </div>
                    <div class="template-items-list" id="task-template-items">
                        <!-- Items dinámicos -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Plantilla
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Task Template Modal -->
    <div class="modal-overlay" id="quick-task-template-modal">
        <div class="modal glass-card">
            <div class="modal-header">
                <h2><i class="fas fa-magic"></i> Aplicar Plantilla de Tareas</h2>
                <button class="btn-icon modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Selecciona una Plantilla</label>
                    <select id="quick-task-template-select" class="select-styled">
                        <option value="">Seleccionar plantilla...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Etapa (opcional)</label>
                    <select id="quick-task-template-stage" class="select-styled">
                        <option value="">Sin etapa específica</option>
                    </select>
                </div>
                <div class="template-preview" id="quick-template-preview">
                    <p class="text-muted">Selecciona una plantilla para ver las tareas que se crearán</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                <button type="button" class="btn btn-primary" id="apply-quick-template-btn">
                    <i class="fas fa-check"></i> Aplicar al Proyecto
                </button>
            </div>
        </div>
    </div>

    <!-- Apply Template Modal -->
    <div class="modal-overlay" id="apply-template-modal">
        <div class="modal glass-card">
            <div class="modal-header">
                <h2 id="apply-template-title"><i class="fas fa-copy"></i> Aplicar Plantilla</h2>
                <button class="btn-icon modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Selecciona el Proyecto</label>
                    <select id="apply-template-project" class="select-styled">
                        <option value="">Seleccionar proyecto...</option>
                    </select>
                </div>
                <div class="form-group hidden" id="apply-template-stage-group">
                    <label>Etapa (opcional)</label>
                    <select id="apply-template-stage" class="select-styled">
                        <option value="">Sin etapa específica</option>
                    </select>
                </div>
                <input type="hidden" id="apply-template-id">
                <input type="hidden" id="apply-template-type">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="applyTemplate()">
                    <i class="fas fa-check"></i> Aplicar
                </button>
            </div>
        </div>
    </div>

    <!-- Add Team Member Modal -->
    <div class="modal-overlay" id="add-team-member-modal">
        <div class="modal glass-card">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Agregar Miembro al Equipo</h2>
                <button class="btn-icon modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Administrador</label>
                    <input type="text" id="team-admin-name" readonly class="input-readonly">
                    <input type="hidden" id="team-admin-id">
                </div>
                <div class="form-group">
                    <label>Selecciona el Usuario</label>
                    <select id="team-member-select" class="select-styled">
                        <option value="">Seleccionar usuario...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="addTeamMember()">
                    <i class="fas fa-user-plus"></i> Agregar
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="/static/app.js?v=3.6.7"></script>
</body>
</html>
