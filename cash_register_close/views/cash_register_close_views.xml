<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ===================================== -->
    <!-- VISTA DE CIERRE DE CAJA PRINCIPAL     -->
    <!-- ===================================== -->

    <!-- Vista Form del Cierre de Caja -->
    <record id="view_cash_register_close_form" model="ir.ui.view">
        <field name="name">cash.register.close.form</field>
        <field name="model">cash.register.close</field>
        <field name="arch" type="xml">
            <form string="Cierre de Caja" class="cash_register_form">
                <header>
                    <button name="action_generate_lines" type="object" 
                            string="Generar Líneas" 
                            class="btn-primary"
                            icon="fa-magic"
                            attrs="{'invisible': [('state', '!=', 'draft')]}"
                            confirm="¿Desea generar las líneas de cierre? Esto eliminará cualquier línea existente."/>
                    <button name="action_close" type="object" 
                            string="Cerrar Caja" 
                            class="btn-success"
                            icon="fa-check-circle"
                            attrs="{'invisible': [('state', '!=', 'in_progress')]}"/>
                    <button name="action_confirm" type="object" 
                            string="Confirmar Cierre" 
                            class="btn-primary"
                            icon="fa-check-double"
                            attrs="{'invisible': [('state', '!=', 'closed')]}"
                            confirm="¿Confirmar este cierre de caja? Esta acción indica supervisión del cierre."/>
                    <button name="action_print_report" type="object" 
                            string="Imprimir Reporte" 
                            class="btn-secondary"
                            icon="fa-print"
                            attrs="{'invisible': [('state', 'not in', ['in_progress', 'closed', 'confirmed'])]}"/>
                    <button name="action_view_movements" type="object" 
                            string="Ver Movimientos" 
                            class="btn-secondary"
                            icon="fa-list"
                            attrs="{'invisible': [('state', '=', 'draft')]}"/>
                    <button name="action_cancel" type="object" 
                            string="Cancelar" 
                            class="btn-secondary"
                            attrs="{'invisible': [('state', 'in', ['closed', 'confirmed', 'cancelled'])]}"/>
                    <button name="action_draft" type="object" 
                            string="Volver a Borrador" 
                            class="btn-secondary"
                            attrs="{'invisible': [('state', 'not in', ['in_progress', 'cancelled'])]}"/>
                    <field name="state" widget="statusbar" 
                           statusbar_visible="draft,in_progress,closed,confirmed"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_movements" type="object" 
                                class="oe_stat_button" icon="fa-exchange"
                                attrs="{'invisible': [('accounts_count', '=', 0)]}">
                            <field name="accounts_count" widget="statinfo" string="Cuentas"/>
                        </button>
                    </div>
                    <widget name="web_ribbon" title="Cerrado" bg_color="bg-success" 
                            attrs="{'invisible': [('state', '!=', 'closed')]}"/>
                    <widget name="web_ribbon" title="Confirmado" bg_color="bg-primary" 
                            attrs="{'invisible': [('state', '!=', 'confirmed')]}"/>
                    <widget name="web_ribbon" title="Cancelado" bg_color="bg-danger" 
                            attrs="{'invisible': [('state', '!=', 'cancelled')]}"/>
                    
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    
                    <group>
                        <group string="Información del Cierre">
                            <field name="date" attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                            <field name="company_id" groups="base.group_multi_company"
                                   attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                            <field name="currency_id" invisible="1"/>
                        </group>
                        <group string="Responsables">
                            <field name="user_id"/>
                            <field name="closed_date" attrs="{'invisible': [('state', 'not in', ['closed', 'confirmed'])]}"/>
                            <field name="confirmed_by_id" attrs="{'invisible': [('state', '!=', 'confirmed')]}"/>
                            <field name="confirmed_date" attrs="{'invisible': [('state', '!=', 'confirmed')]}"/>
                        </group>
                    </group>
                    
                    <!-- Firmas digitales -->
                    <group attrs="{'invisible': [('state', 'not in', ['closed', 'confirmed'])]}">
                        <group string="Firma del Responsable (Cierre)">
                            <field name="closed_signature" widget="image" 
                                   class="oe_avatar" readonly="1"
                                   attrs="{'invisible': [('closed_signature', '=', False)]}"/>
                        </group>
                        <group string="Firma del Supervisor (Confirmación)" 
                               attrs="{'invisible': [('state', '!=', 'confirmed')]}">
                            <field name="confirmed_signature" widget="image" 
                                   class="oe_avatar" readonly="1"
                                   attrs="{'invisible': [('confirmed_signature', '=', False)]}"/>
                        </group>
                    </group>

                    <!-- Dashboard de Totales - DUAL CURRENCY -->
                    <div class="cash_register_dashboard mt-4 mb-4" 
                         attrs="{'invisible': [('state', '=', 'draft')]}">
                        
                        <!-- Totales en Bolívares -->
                        <h5 class="text-muted mb-3"><i class="fa fa-money me-2"/>Totales en Bolívares (Bs)</h5>
                        <div class="row mb-4">
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #3b7ddd; background: #f8f9fa;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1">Saldo Inicial</small>
                                        <h4 class="mb-0 text-primary fw-bold">
                                            <field name="total_initial_balance_bs"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #28a745; background: #f8f9fa;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1"><i class="fa fa-arrow-up text-success"/> Ingresos</small>
                                        <h4 class="mb-0 text-success fw-bold">
                                            <field name="total_income_bs"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #dc3545; background: #f8f9fa;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1"><i class="fa fa-arrow-down text-danger"/> Egresos</small>
                                        <h4 class="mb-0 text-danger fw-bold">
                                            <field name="total_expense_bs"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #17a2b8; background: #f8f9fa;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1">Saldo Final</small>
                                        <h4 class="mb-0 text-info fw-bold">
                                            <field name="total_final_balance_bs"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #6c757d; background: #f8f9fa;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1"><i class="fa fa-calculator"/> Contado</small>
                                        <h4 class="mb-0 text-secondary fw-bold">
                                            <field name="total_counted_bs"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #ffc107; background: #fffbeb;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1">Diferencia</small>
                                        <h4 class="mb-0 fw-bold" style="color: #856404;">
                                            <field name="total_difference_bs"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Totales en USD -->
                        <h5 class="text-muted mb-3"><i class="fa fa-dollar me-2"/>Totales en Dólares (USD)</h5>
                        <div class="row mb-4">
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #28a745; background: #f0fff4;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1">Saldo Inicial</small>
                                        <h4 class="mb-0 fw-bold" style="color: #155724;">
                                            $ <field name="total_initial_balance_usd"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #28a745; background: #f0fff4;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1"><i class="fa fa-arrow-up text-success"/> Ingresos</small>
                                        <h4 class="mb-0 text-success fw-bold">
                                            $ <field name="total_income_usd"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #dc3545; background: #fff5f5;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1"><i class="fa fa-arrow-down text-danger"/> Egresos</small>
                                        <h4 class="mb-0 text-danger fw-bold">
                                            $ <field name="total_expense_usd"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #28a745; background: #f0fff4;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1">Saldo Final</small>
                                        <h4 class="mb-0 fw-bold" style="color: #155724;">
                                            $ <field name="total_final_balance_usd"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #28a745; background: #f0fff4;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1"><i class="fa fa-calculator"/> Contado</small>
                                        <h4 class="mb-0 fw-bold" style="color: #155724;">
                                            $ <field name="total_counted_usd"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #ffc107; background: #fffbeb;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1">Diferencia</small>
                                        <h4 class="mb-0 fw-bold" style="color: #856404;">
                                            $ <field name="total_difference_usd"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Totales en EUR -->
                        <h5 class="text-muted mb-3"><i class="fa fa-euro me-2"/>Totales en Euros (EUR)</h5>
                        <div class="row mb-4">
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #6f42c1; background: #f8f5ff;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1">Saldo Inicial</small>
                                        <h4 class="mb-0 fw-bold" style="color: #5a32a3;">
                                            € <field name="total_initial_balance_eur"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #28a745; background: #f0fff4;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1"><i class="fa fa-arrow-up text-success"/> Ingresos</small>
                                        <h4 class="mb-0 text-success fw-bold">
                                            € <field name="total_income_eur"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #dc3545; background: #fff5f5;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1"><i class="fa fa-arrow-down text-danger"/> Egresos</small>
                                        <h4 class="mb-0 text-danger fw-bold">
                                            € <field name="total_expense_eur"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #6f42c1; background: #f8f5ff;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1">Saldo Final</small>
                                        <h4 class="mb-0 fw-bold" style="color: #5a32a3;">
                                            € <field name="total_final_balance_eur"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #6f42c1; background: #f8f5ff;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1"><i class="fa fa-calculator"/> Contado</small>
                                        <h4 class="mb-0 fw-bold" style="color: #5a32a3;">
                                            € <field name="total_counted_eur"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="card h-100 shadow-sm" style="border-left: 4px solid #ffc107; background: #fffbeb;">
                                    <div class="card-body text-center py-3">
                                        <small class="text-muted d-block mb-1">Diferencia</small>
                                        <h4 class="mb-0 fw-bold" style="color: #856404;">
                                            € <field name="total_difference_eur"/>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Contador de cuentas -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-light border">
                                    <div class="d-flex justify-content-around">
                                        <span><i class="fa fa-list-alt me-1"/> Total Cuentas: <strong><field name="accounts_count"/></strong></span>
                                        <span><i class="fa fa-money me-1"/> Cuentas Bs: <strong><field name="accounts_bs_count"/></strong></span>
                                        <span><i class="fa fa-dollar me-1"/> Cuentas USD: <strong><field name="accounts_usd_count"/></strong></span>
                                        <span><i class="fa fa-euro me-1"/> Cuentas EUR: <strong><field name="accounts_eur_count"/></strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <notebook>
                        <page string="Cuentas de Efectivo" name="accounts">
                            <field name="line_ids" mode="tree,kanban" 
                                   attrs="{'readonly': [('state', '=', 'closed')]}">
                                <tree string="Cuentas" editable="bottom" 
                                      decoration-success="is_counted == True"
                                      decoration-warning="is_counted == False and state == 'in_progress'"
                                      decoration-muted="state == 'closed'">
                                    <field name="state" invisible="1"/>
                                    <field name="account_id" readonly="1"/>
                                    <field name="currency_id" readonly="1"/>
                                    <field name="is_usd_account" invisible="1"/>
                                    <field name="is_eur_account" invisible="1"/>
                                    
                                    <!-- Columnas con Moneda -->
                                    <field name="initial_balance" string="Inicio" readonly="1" widget="monetary"/>
                                    <field name="total_income" string="Ingresos" readonly="1" widget="monetary"
                                           class="text-success fw-bold"/>
                                    <field name="total_expense" string="Egresos" readonly="1" widget="monetary"
                                           class="text-danger fw-bold"/>
                                    <field name="final_balance" string="Final" readonly="1" widget="monetary"
                                           class="text-info fw-bold"/>
                                    <field name="counted_amount" string="Contado" widget="monetary"/>
                                    <field name="difference" string="Diferencia" widget="monetary"
                                           decoration-danger="difference &lt; 0"
                                           decoration-success="difference == 0"
                                           decoration-warning="difference &gt; 0"/>
                                    
                                    <field name="is_counted" widget="boolean_toggle"/>
                                    <field name="total_bad_bills" optional="hide" widget="monetary"/>
                                    <field name="movement_count" string="Movs."/>
                                    <button name="action_count_cash" type="object" 
                                            icon="fa-calculator" title="Contar Efectivo"
                                            class="btn-link"
                                            attrs="{'invisible': [('state', '=', 'closed')]}"/>
                                    <button name="action_view_movements" type="object" 
                                            icon="fa-list" title="Ver Movimientos"
                                            class="btn-link"/>
                                </tree>
                                <kanban class="o_kanban_mobile">
                                    <field name="account_id"/>
                                    <field name="currency_id"/>
                                    <field name="is_usd_account"/>
                                    <field name="is_eur_account"/>
                                    <field name="initial_balance"/>
                                    <field name="total_income"/>
                                    <field name="total_expense"/>
                                    <field name="final_balance"/>
                                    <field name="counted_amount"/>
                                    <field name="difference"/>
                                    <field name="is_counted"/>
                                    <templates>
                                        <t t-name="kanban-box">
                                            <div class="oe_kanban_card oe_kanban_global_click">
                                                <div class="oe_kanban_content">
                                                    <div class="o_kanban_record_top">
                                                        <strong><field name="account_id"/></strong>
                                                        <span t-if="record.is_counted.raw_value" 
                                                              class="badge bg-success">Contado</span>
                                                        <span class="badge bg-secondary">
                                                            <field name="currency_id"/>
                                                        </span>
                                                    </div>
                                                    <div class="o_kanban_record_body">
                                                        <div class="d-flex justify-content-between">
                                                            <span>Saldo Inicial:</span>
                                                            <span><field name="initial_balance" widget="monetary"/></span>
                                                        </div>
                                                        <div class="d-flex justify-content-between text-success">
                                                            <span>Ingresos:</span>
                                                            <span><field name="total_income" widget="monetary"/></span>
                                                        </div>
                                                        <div class="d-flex justify-content-between text-danger">
                                                            <span>Egresos:</span>
                                                            <span><field name="total_expense" widget="monetary"/></span>
                                                        </div>
                                                        <div class="d-flex justify-content-between fw-bold text-primary">
                                                            <span>Saldo Final:</span>
                                                            <span><field name="final_balance" widget="monetary"/></span>
                                                        </div>
                                                        <div class="d-flex justify-content-between mt-2 pt-2 border-top">
                                                            <span>Contado:</span>
                                                            <span><field name="counted_amount" widget="monetary"/></span>
                                                        </div>
                                                        <div class="d-flex justify-content-between fw-bold">
                                                            <span>Diferencia:</span>
                                                            <span><field name="difference" widget="monetary"/></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </t>
                                    </templates>
                                </kanban>
                            </field>
                        </page>
                        <page string="Cuentas Bancarias" name="bank_accounts">
                            <field name="bank_line_ids" nolabel="1"
                                   attrs="{'readonly': [('state', 'in', ['closed', 'confirmed'])]}">
                                <tree string="Cuentas Bancarias" editable="bottom">
                                    <field name="account_id" 
                                           options="{'no_create': True}"
                                           domain="[('is_bank_account', '=', True)]"/>
                                    <field name="currency_id" readonly="1"/>
                                    <field name="closing_balance" widget="monetary"/>
                                    <field name="notes"/>
                                </tree>
                            </field>
                        </page>
                        <page string="Observaciones" name="notes">
                            <field name="notes" placeholder="Escriba sus observaciones aquí..."/>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Vista Tree del Cierre de Caja -->
    <record id="view_cash_register_close_tree" model="ir.ui.view">
        <field name="name">cash.register.close.tree</field>
        <field name="model">cash.register.close</field>
        <field name="arch" type="xml">
            <tree string="Cierres de Caja" 
                  decoration-info="state == 'draft'"
                  decoration-warning="state == 'in_progress'"
                  decoration-success="state == 'closed'"
                  decoration-muted="state == 'cancelled'">
                <field name="name"/>
                <field name="date"/>
                <field name="company_id" groups="base.group_multi_company"/>
                <field name="user_id" widget="many2one_avatar_user"/>
                <!-- USD: Inicio y Fin -->
                <field name="total_initial_balance_usd" string="Inicio USD" sum="Total"/>
                <field name="total_final_balance_usd" string="Fin USD" sum="Total"/>
                <!-- EUR: Inicio y Fin -->
                <field name="total_initial_balance_eur" string="Inicio EUR" sum="Total"/>
                <field name="total_final_balance_eur" string="Fin EUR" sum="Total"/>
                <!-- Bs: Inicio y Fin -->
                <field name="total_initial_balance_bs" string="Inicio Bs" sum="Total"/>
                <field name="total_final_balance_bs" string="Fin Bs" sum="Total"/>
                <!-- Estado -->
                <field name="currency_id" invisible="1"/>
                <field name="state" widget="badge"
                       decoration-info="state == 'draft'"
                       decoration-warning="state == 'in_progress'"
                       decoration-success="state == 'closed'"
                       decoration-danger="state == 'cancelled'"/>
            </tree>
        </field>
    </record>

    <!-- Vista Kanban del Cierre de Caja -->
    <record id="view_cash_register_close_kanban" model="ir.ui.view">
        <field name="name">cash.register.close.kanban</field>
        <field name="model">cash.register.close</field>
        <field name="arch" type="xml">
            <kanban class="o_cash_register_kanban" default_group_by="state" quick_create="false">
                <field name="name"/>
                <field name="date"/>
                <field name="company_id"/>
                <field name="user_id"/>
                <field name="state"/>
                <field name="total_initial_balance_bs"/>
                <field name="total_income_bs"/>
                <field name="total_expense_bs"/>
                <field name="total_final_balance_bs"/>
                <field name="total_difference_bs"/>
                <field name="total_initial_balance_usd"/>
                <field name="total_income_usd"/>
                <field name="total_expense_usd"/>
                <field name="total_final_balance_usd"/>
                <field name="total_difference_usd"/>
                <field name="accounts_count"/>
                <field name="accounts_bs_count"/>
                <field name="accounts_usd_count"/>
                <field name="currency_id"/>
                <progressbar field="state" 
                             colors='{"draft": "secondary", "in_progress": "warning", "closed": "success", "cancelled": "danger"}'/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click #{record.state.raw_value == 'closed' ? 'border-success' : ''} #{record.state.raw_value == 'cancelled' ? 'opacity-50' : ''}">
                            <div class="oe_kanban_content p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong class="fs-5">
                                        <field name="name"/>
                                    </strong>
                                    <field name="state" widget="label_selection" 
                                           options="{'classes': {'draft': 'secondary', 'in_progress': 'warning', 'closed': 'success', 'cancelled': 'danger'}}"/>
                                </div>
                                
                                <div class="mb-2">
                                    <span class="text-muted">
                                        <i class="fa fa-calendar me-1"/>
                                        <field name="date"/>
                                    </span>
                                </div>
                                
                                <div class="mb-2" t-if="record.company_id.value">
                                    <span class="text-muted">
                                        <i class="fa fa-building me-1"/>
                                        <field name="company_id"/>
                                    </span>
                                </div>
                                
                                <!-- Saldos en Bs -->
                                <div class="row g-2 mt-3">
                                    <div class="col-12">
                                        <small class="text-muted fw-bold"><i class="fa fa-money me-1"/>Bolívares</small>
                                    </div>
                                    <div class="col-6">
                                        <div class="bg-light rounded p-2 text-center">
                                            <small class="text-muted d-block">Saldo Final Bs</small>
                                            <span class="fw-bold text-primary">
                                                <field name="total_final_balance_bs"/>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="rounded p-2 text-center" style="background-color: rgba(40, 167, 69, 0.1);">
                                            <small class="text-success d-block">Diferencia Bs</small>
                                            <span class="fw-bold text-success">
                                                <field name="total_difference_bs"/>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Saldos en USD -->
                                <div class="row g-2 mt-2">
                                    <div class="col-12">
                                        <small class="text-muted fw-bold"><i class="fa fa-dollar me-1"/>USD</small>
                                    </div>
                                    <div class="col-6">
                                        <div class="rounded p-2 text-center" style="background-color: rgba(23, 162, 184, 0.1);">
                                            <small class="text-info d-block">Saldo Final USD</small>
                                            <span class="fw-bold text-info">
                                                $ <field name="total_final_balance_usd"/>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="rounded p-2 text-center" style="background-color: rgba(255, 193, 7, 0.1);">
                                            <small class="text-warning d-block">Diferencia USD</small>
                                            <span class="fw-bold text-warning">
                                                $ <field name="total_difference_usd"/>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3 pt-2 border-top d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge bg-info me-1">
                                            <field name="accounts_count"/> Cuentas
                                        </span>
                                        <span class="badge bg-secondary me-1">
                                            <field name="accounts_bs_count"/> Bs
                                        </span>
                                        <span class="badge bg-success">
                                            <field name="accounts_usd_count"/> USD
                                        </span>
                                    </div>
                                    <div>
                                        <img t-att-src="kanban_image('res.users', 'avatar_128', record.user_id.raw_value)" 
                                             t-att-title="record.user_id.value" 
                                             t-att-alt="record.user_id.value"
                                             class="rounded-circle" width="24" height="24"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Vista Search del Cierre de Caja -->
    <record id="view_cash_register_close_search" model="ir.ui.view">
        <field name="name">cash.register.close.search</field>
        <field name="model">cash.register.close</field>
        <field name="arch" type="xml">
            <search string="Buscar Cierres de Caja">
                <field name="name"/>
                <field name="date"/>
                <field name="company_id"/>
                <field name="user_id"/>
                <separator/>
                <filter string="Hoy" name="filter_today" 
                        domain="[('date', '=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter string="Esta Semana" name="filter_this_week" 
                        domain="[('date', '>=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                <filter string="Este Mes" name="filter_this_month" 
                        domain="[('date', '>=', context_today().strftime('%Y-%m-01'))]"/>
                <separator/>
                <filter string="Borrador" name="filter_draft" domain="[('state', '=', 'draft')]"/>
                <filter string="En Proceso" name="filter_in_progress" domain="[('state', '=', 'in_progress')]"/>
                <filter string="Cerrado" name="filter_closed" domain="[('state', '=', 'closed')]"/>
                <filter string="Cancelado" name="filter_cancelled" domain="[('state', '=', 'cancelled')]"/>
                <separator/>
                <filter string="Con Diferencia Bs" name="filter_with_difference_bs" 
                        domain="[('total_difference_bs', '!=', 0)]"/>
                <filter string="Con Diferencia USD" name="filter_with_difference_usd" 
                        domain="[('total_difference_usd', '!=', 0)]"/>
                <separator/>
                <filter string="Mis Cierres" name="filter_my_closes" 
                        domain="[('user_id', '=', uid)]"/>
                <group expand="0" string="Agrupar por">
                    <filter string="Estado" name="group_by_state" context="{'group_by': 'state'}"/>
                    <filter string="Fecha" name="group_by_date" context="{'group_by': 'date:day'}"/>
                    <filter string="Mes" name="group_by_month" context="{'group_by': 'date:month'}"/>
                    <filter string="Compañía" name="group_by_company" context="{'group_by': 'company_id'}"/>
                    <filter string="Responsable" name="group_by_user" context="{'group_by': 'user_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Vista Calendar del Cierre de Caja -->
    <record id="view_cash_register_close_calendar" model="ir.ui.view">
        <field name="name">cash.register.close.calendar</field>
        <field name="model">cash.register.close</field>
        <field name="arch" type="xml">
            <calendar string="Cierres de Caja" date_start="date" mode="month" 
                      color="state" quick_add="False" event_open_popup="true">
                <field name="name"/>
                <field name="company_id"/>
                <field name="total_final_balance_bs"/>
                <field name="total_final_balance_usd"/>
                <field name="state"/>
            </calendar>
        </field>
    </record>

    <!-- Vista Pivot del Cierre de Caja -->
    <record id="view_cash_register_close_pivot" model="ir.ui.view">
        <field name="name">cash.register.close.pivot</field>
        <field name="model">cash.register.close</field>
        <field name="arch" type="xml">
            <pivot string="Análisis de Cierres de Caja">
                <field name="date" type="row" interval="month"/>
                <field name="company_id" type="col"/>
                <field name="total_initial_balance_bs" type="measure"/>
                <field name="total_income_bs" type="measure"/>
                <field name="total_expense_bs" type="measure"/>
                <field name="total_final_balance_bs" type="measure"/>
                <field name="total_difference_bs" type="measure"/>
                <field name="total_initial_balance_usd" type="measure"/>
                <field name="total_income_usd" type="measure"/>
                <field name="total_expense_usd" type="measure"/>
                <field name="total_final_balance_usd" type="measure"/>
                <field name="total_difference_usd" type="measure"/>
            </pivot>
        </field>
    </record>

    <!-- Vista Graph del Cierre de Caja -->
    <record id="view_cash_register_close_graph" model="ir.ui.view">
        <field name="name">cash.register.close.graph</field>
        <field name="model">cash.register.close</field>
        <field name="arch" type="xml">
            <graph string="Cierres de Caja" type="bar" stacked="True">
                <field name="date" type="row" interval="day"/>
                <field name="total_income_bs" type="measure"/>
                <field name="total_expense_bs" type="measure"/>
                <field name="total_income_usd" type="measure"/>
                <field name="total_expense_usd" type="measure"/>
            </graph>
        </field>
    </record>

    <!-- ================================================ -->
    <!-- VISTA DE LÍNEA DE CIERRE - FORMULARIO DE CONTEO -->
    <!-- ================================================ -->

    <record id="view_cash_register_close_line_count_form" model="ir.ui.view">
        <field name="name">cash.register.close.line.count.form</field>
        <field name="model">cash.register.close.line</field>
        <field name="arch" type="xml">
            <form string="Contar Efectivo" class="cash_count_form">
                <sheet>
                    <div class="oe_title mb-4">
                        <h2>
                            <span>Conteo de Efectivo - </span>
                            <field name="account_id" readonly="1" class="oe_inline"/>
                            <span class="badge bg-secondary ms-2">
                                <field name="currency_id" readonly="1"/>
                            </span>
                        </h2>
                    </div>
                    
                    <field name="is_usd_account" invisible="1"/>
                    <field name="is_eur_account" invisible="1"/>
                    
                    <!-- Resumen del día -->
                    <div class="alert alert-info" role="alert">
                        <h6 class="alert-heading mb-3">
                            <i class="fa fa-money me-2"/>Resumen de Saldos
                        </h6>
                        <div class="row">
                            <div class="col-md-3 text-center">
                                <small class="text-muted">Saldo Inicial</small>
                                <h5><field name="initial_balance" readonly="1" widget="monetary"/></h5>
                            </div>
                            <div class="col-md-3 text-center">
                                <small class="text-success">+ Ingresos</small>
                                <h5 class="text-success">
                                    <field name="total_income" readonly="1" widget="monetary"/>
                                </h5>
                            </div>
                            <div class="col-md-3 text-center">
                                <small class="text-danger">- Egresos</small>
                                <h5 class="text-danger">
                                    <field name="total_expense" readonly="1" widget="monetary"/>
                                </h5>
                            </div>
                            <div class="col-md-3 text-center">
                                <small class="text-primary">= Saldo Final</small>
                                <h4 class="text-primary fw-bold">
                                    <field name="final_balance" readonly="1" widget="monetary"/>
                                </h4>
                            </div>
                        </div>
                    </div>
                    
                    <field name="currency_id" invisible="1"/>
                    
                    <notebook>
                        <page string="Denominaciones" name="denominations">
                            <group>
                                <group>
                                    <button name="action_load_denominations" type="object" 
                                            string="Cargar Denominaciones" 
                                            class="btn-link"
                                            icon="fa-refresh"
                                            attrs="{'invisible': [('denomination_line_ids', '!=', [])]}"/>
                                    <button name="action_copy_from_previous_close" type="object" 
                                            string="Copiar del Cierre Anterior" 
                                            class="btn-secondary"
                                            icon="fa-copy"/>
                                </group>
                            </group>
                            
                            <field name="denomination_line_ids" nolabel="1">
                                <tree string="Denominaciones" editable="bottom">
                                    <field name="denomination_id"/>
                                    <field name="denomination_type" readonly="1"/>
                                    <field name="denomination_value" readonly="1"/>
                                    <field name="currency_id" invisible="1"/>
                                    <field name="quantity"/>
                                    <field name="total" widget="monetary" readonly="1" sum="Total"/>
                                </tree>
                            </field>
                            
                            <group class="mt-4">
                                <group string="Totales">
                                    <field name="counted_amount" readonly="1" widget="monetary"
                                           class="fs-4 fw-bold"/>
                                    <field name="difference" readonly="1" widget="monetary"
                                           class="fs-4 fw-bold"
                                           decoration-danger="difference &lt; 0"
                                           decoration-success="difference == 0"
                                           decoration-warning="difference &gt; 0"/>
                                </group>
                            </group>
                        </page>
                        
                        <page string="Billetes en Mal Estado" name="bad_bills">
                            <group>
                                <group>
                                    <button name="action_copy_from_previous_close" type="object" 
                                            string="Copiar del Cierre Anterior" 
                                            class="btn-secondary"
                                            icon="fa-copy"/>
                                </group>
                            </group>
                            
                            <field name="bad_bills_ids" nolabel="1">
                                <tree string="Billetes en Mal Estado" editable="bottom">
                                    <field name="denomination_id" 
                                           domain="[('denomination_type', '=', 'bill')]"/>
                                    <field name="denomination_value" readonly="1"/>
                                    <field name="currency_id" invisible="1"/>
                                    <field name="condition"/>
                                    <field name="quantity"/>
                                    <field name="total" widget="monetary" readonly="1" sum="Total"/>
                                    <field name="notes"/>
                                </tree>
                            </field>
                            
                            <group class="mt-4">
                                <group>
                                    <field name="total_bad_bills" widget="monetary" readonly="1"
                                           string="Total Billetes Mal Estado"
                                           class="fs-5 fw-bold text-warning"/>
                                </group>
                            </group>
                        </page>
                        
                        <page string="Observaciones" name="notes">
                            <field name="notes" placeholder="Escriba observaciones adicionales..."/>
                        </page>
                    </notebook>
                </sheet>
                <footer>
                    <button name="action_confirm_count" type="object" 
                            string="Confirmar Conteo" class="btn-primary"/>
                    <button string="Cerrar" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Vista Form de la Línea de Cierre -->
    <record id="view_cash_register_close_line_form" model="ir.ui.view">
        <field name="name">cash.register.close.line.form</field>
        <field name="model">cash.register.close.line</field>
        <field name="arch" type="xml">
            <form string="Línea de Cierre de Caja">
                <sheet>
                    <group>
                        <group string="Información General">
                            <field name="close_id"/>
                            <field name="account_id"/>
                            <field name="currency_id"/>
                            <field name="is_usd_account" readonly="1"/>
                            <field name="is_eur_account" readonly="1"/>
                            <field name="date"/>
                        </group>
                        <group string="Estado">
                            <field name="is_counted"/>
                            <field name="total_bad_bills" widget="monetary"/>
                            <field name="movement_count"/>
                        </group>
                    </group>
                    <group>
                        <group string="Saldos">
                            <field name="initial_balance" widget="monetary"/>
                            <field name="total_income" widget="monetary"/>
                            <field name="total_expense" widget="monetary"/>
                            <field name="final_balance" widget="monetary"/>
                            <field name="counted_amount" widget="monetary"/>
                            <field name="difference" widget="monetary"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Denominaciones">
                            <field name="denomination_line_ids">
                                <tree editable="bottom">
                                    <field name="denomination_id"/>
                                    <field name="quantity"/>
                                    <field name="total"/>
                                </tree>
                            </field>
                        </page>
                        <page string="Billetes Mal Estado">
                            <field name="bad_bills_ids">
                                <tree editable="bottom">
                                    <field name="denomination_id"/>
                                    <field name="condition"/>
                                    <field name="quantity"/>
                                    <field name="total"/>
                                    <field name="notes"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>
                    <field name="notes"/>
                </sheet>
            </form>
        </field>
    </record>

    <!-- ================================= -->
    <!-- WIZARD CIERRE MASIVO              -->
    <!-- ================================= -->

    <record id="view_cash_register_close_wizard_form" model="ir.ui.view">
        <field name="name">cash.register.close.wizard.form</field>
        <field name="model">cash.register.close.wizard</field>
        <field name="arch" type="xml">
            <form string="Cierre Masivo de Cajas">
                <div class="alert alert-info text-center mb-4" role="alert">
                    <h4 class="alert-heading">
                        <i class="fa fa-magic me-2"/>
                        Cierre Masivo de Cajas
                    </h4>
                    <p class="mb-0">
                        Genere cierres de caja para múltiples compañías con un solo clic.
                    </p>
                </div>
                
                <group>
                    <group>
                        <field name="date"/>
                        <field name="close_all_companies" widget="boolean_toggle"/>
                    </group>
                </group>
                
                <group string="Compañías a Procesar" 
                       attrs="{'invisible': [('close_all_companies', '=', True)]}">
                    <field name="company_ids" widget="many2many_tags" nolabel="1"
                           options="{'no_create': True, 'no_open': True}"/>
                </group>
                
                <footer>
                    <button name="action_create_closes" type="object" 
                            string="Generar Cierres" class="btn-primary"
                            icon="fa-check"/>
                    <button name="action_preview" type="object" 
                            string="Vista Previa" class="btn-secondary"
                            icon="fa-eye"/>
                    <button string="Cancelar" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Acción del Wizard -->
    <record id="action_cash_register_close_wizard" model="ir.actions.act_window">
        <field name="name">Cierre Masivo de Cajas</field>
        <field name="res_model">cash.register.close.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>

    <!-- ================================= -->
    <!-- VISTA DE MOVIMIENTOS SIMPLIFICADA -->
    <!-- ================================= -->
    
    <!-- Vista Tree simplificada para movimientos de cierre -->
    <record id="view_account_move_line_cash_close_tree" model="ir.ui.view">
        <field name="name">account.move.line.cash.close.tree</field>
        <field name="model">account.move.line</field>
        <field name="priority">100</field>
        <field name="arch" type="xml">
            <tree string="Movimientos de Caja" create="false" edit="false" delete="false">
                <field name="date" string="Fecha"/>
                <field name="partner_id" string="Empresa/Cliente"/>
                <field name="name" string="Etiqueta"/>
                <field name="amount_currency" string="Monto" 
                       decoration-success="amount_currency > 0"
                       decoration-danger="amount_currency &lt; 0"/>
                <field name="currency_id" string="Moneda"/>
                <field name="move_id" string="Asiento" invisible="1"/>
                <button name="action_open_move" type="object" 
                        string="Ver Asiento" icon="fa-external-link"
                        class="btn-link"/>
            </tree>
        </field>
    </record>
    
    <!-- Vista Form simplificada para movimientos (solo lectura) -->
    <record id="view_account_move_line_cash_close_form" model="ir.ui.view">
        <field name="name">account.move.line.cash.close.form</field>
        <field name="model">account.move.line</field>
        <field name="priority">100</field>
        <field name="arch" type="xml">
            <form string="Detalle de Movimiento" create="false" edit="false">
                <sheet>
                    <group>
                        <group>
                            <field name="date" string="Fecha"/>
                            <field name="partner_id" string="Empresa/Cliente"/>
                            <field name="name" string="Etiqueta"/>
                        </group>
                        <group>
                            <field name="amount_currency" string="Monto"/>
                            <field name="currency_id" string="Moneda"/>
                            <field name="debit" string="Debe"/>
                            <field name="credit" string="Haber"/>
                        </group>
                    </group>
                    <group string="Referencia">
                        <field name="ref" string="Referencia"/>
                        <field name="move_id" string="Asiento Contable"/>
                    </group>
                </sheet>
                <footer>
                    <button string="Ver Asiento Completo" name="action_open_move" type="object" 
                            class="btn-primary" icon="fa-external-link"/>
                    <button string="Cerrar" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- ================================= -->
    <!-- ACCIONES PRINCIPALES              -->
    <!-- ================================= -->

    <!-- Acción principal de Cierre de Caja -->
    <record id="action_cash_register_close" model="ir.actions.act_window">
        <field name="name">Cierre de Caja Diario</field>
        <field name="res_model">cash.register.close</field>
        <field name="view_mode">tree,kanban,form,calendar,pivot,graph</field>
        <field name="search_view_id" ref="view_cash_register_close_search"/>
        <field name="context">{
            'search_default_filter_today': 0,
            'search_default_filter_in_progress': 0,
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Crear su primer cierre de caja
            </p>
            <p>
                Gestione sus cierres de caja diarios de manera automatizada.
                <br/>
                Configure las cuentas contables como "Cuenta de Efectivo" para comenzar.
            </p>
        </field>
    </record>

    <!-- Acción para crear nuevo cierre rápido -->
    <record id="action_cash_register_close_new" model="ir.actions.act_window">
        <field name="name">Nuevo Cierre de Caja</field>
        <field name="res_model">cash.register.close</field>
        <field name="view_mode">form</field>
        <field name="target">current</field>
    </record>

</odoo>
